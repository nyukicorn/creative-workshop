name: Creative Workshop v2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  creative-workflow:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python and Dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        pip install requests pillow
        
        
    - name: Phase 1 - Generate Assets with Kamui Code MCP
      run: |
        echo "Kamui Code MCPã§æ–°ã—ã„ç´ æã‚’ç”Ÿæˆé–‹å§‹"
        mkdir -p assets/panorama assets/audio
        
        # Kamui Code MCPã§æ–°ã—ã„ç´ æã‚’å®Ÿéš›ã«ç”Ÿæˆ
        echo "ğŸ–¼ï¸ Imagen3ã§æ–°ã—ã„ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆä¸­..."
        python3 << 'PYTHON_SCRIPT'
        import requests
        import json
        
        # Imagen3 APIå‘¼ã³å‡ºã—
        response = requests.post(
            'https://mcp-veo3-fast-only-20250709-220921-05b3effb-zl3xx5lsaq-uc.a.run.app/t2i/google/imagen',
            json={
                'prompt': 'ç¥ç§˜çš„ãªæ£®ã®ä¸­ã®å¤ã„çŸ³ã®éºè·¡ã€å¤•æš®ã‚Œã®å…‰ãŒå·®ã—è¾¼ã‚€å¹»æƒ³çš„ãª360åº¦ãƒ‘ãƒãƒ©ãƒé¢¨æ™¯ã€Equirectangularå½¢å¼',
                'width': 1024,
                'height': 1024
            },
            timeout=120
        )
        
        if response.status_code == 200:
            with open('assets/panorama/panorama_landscape.png', 'wb') as f:
                f.write(response.content)
            print("âœ… ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆå®Œäº†")
        else:
            print(f"âŒ ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: {response.status_code}")
        PYTHON_SCRIPT
        
        echo "ğŸµ Lyriaã§æ–°ã—ã„ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆä¸­..."
        python3 << 'PYTHON_SCRIPT'
        import requests
        
        # Lyria APIå‘¼ã³å‡ºã—
        response = requests.post(
            'https://mcp-veo3-fast-only-20250709-220921-05b3effb-zl3xx5lsaq-uc.a.run.app/t2m/google/lyria',
            json={
                'prompt': 'æ£®ã®è‡ªç„¶éŸ³ã¨ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆã€VRä½“é¨“ã«é©ã—ãŸãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã‚‹ã‚µã‚¦ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ã€60ç§’ãƒ«ãƒ¼ãƒ—å¯èƒ½',
                'duration': 60
            },
            timeout=180
        )
        
        if response.status_code == 200:
            with open('assets/audio/ambient_background.wav', 'wb') as f:
                f.write(response.content)
            print("âœ… ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆå®Œäº†")
        else:
            print(f"âŒ éŸ³æ¥½ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {response.status_code}")
        PYTHON_SCRIPT
        
        # ç”Ÿæˆçµæœç¢ºèª
        python3 << 'EOF'
        import os
        panorama_exists = os.path.exists('assets/panorama/panorama_landscape.png')
        audio_exists = os.path.exists('assets/audio/ambient_background.wav')
        print(f"ğŸ“Š ç”Ÿæˆçµæœ: ãƒ‘ãƒãƒ©ãƒç”»åƒ={panorama_exists}, éŸ³æ¥½={audio_exists}")
        if panorama_exists:
            import os
            size = os.path.getsize('assets/panorama/panorama_landscape.png')
            print(f"ãƒ‘ãƒãƒ©ãƒç”»åƒã‚µã‚¤ã‚º: {size} bytes")
        if audio_exists:
            size = os.path.getsize('assets/audio/ambient_background.wav')
            print(f"éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: {size} bytes")
        EOF
        
    - name: Verify Panorama Asset Generation
      run: |
        echo "ãƒ‘ãƒãƒ©ãƒç´ æç”Ÿæˆç¢ºèª"
        ls -la assets/panorama/ || echo "No panorama directory"
        ls -la assets/audio/ || echo "No audio directory"
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª"
        du -h assets/panorama/* || echo "No panorama files"
        du -h assets/audio/* || echo "No audio files"
        
    - name: Upload Generated Assets
      uses: actions/upload-artifact@v4
      with:
        name: generated-assets
        path: assets/
        retention-days: 30
        
    - name: Phase 2 - Panorama VR Integration (Three.js)
      run: |
        echo "Three.jsã§ãƒ‘ãƒãƒ©ãƒVRçµ±åˆé–‹å§‹"
        mkdir -p dist
        python3 << 'EOF'
        import os
        import json
        
        # Three.js ãƒ‘ãƒãƒ©ãƒãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ç”Ÿæˆ
        html_content = '''<!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>360Â° Panorama VR Experience</title>
            <style>
                body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
                #info { position: absolute; top: 10px; left: 10px; color: white; z-index: 100; }
                #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
                button { padding: 10px 20px; margin: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px; cursor: pointer; }
                button:hover { background: rgba(0,0,0,0.9); }
            </style>
        </head>
        <body>
            <div id="info">
                <h3>360Â° Panorama VR</h3>
                <p>ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ç§»å‹• | ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  | VRå¯¾å¿œ</p>
            </div>
            <div id="controls">
                <button onclick="toggleAudio()">éŸ³æ¥½ ON/OFF</button>
                <button onclick="enterVR()">VRãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            <audio id="bgAudio" loop>
                <source src="./assets/audio/ambient_background.wav" type="audio/wav">
            </audio>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
            <script>
                let scene, camera, renderer, controls, audio;
                
                function init() {
                    // ã‚·ãƒ¼ãƒ³è¨­å®š
                    scene = new THREE.Scene();
                    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    document.body.appendChild(renderer.domElement);
                    
                    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    controls.enableZoom = true;
                    controls.enablePan = false;
                    controls.enableRotate = true;
                    controls.rotateSpeed = 0.5;
                    controls.zoomSpeed = 1.5;
                    controls.minDistance = 1;
                    controls.maxDistance = 200;
                    
                    // ãƒ‘ãƒãƒ©ãƒã‚¹ãƒ•ã‚£ã‚¢ä½œæˆ
                    const geometry = new THREE.SphereGeometry(500, 60, 40);
                    geometry.scale(-1, 1, 1); // å†…å´ã‹ã‚‰è¦‹ãˆã‚‹ã‚ˆã†ã«åè»¢
                    
                    const loader = new THREE.TextureLoader();
                    loader.load('./assets/panorama/panorama_landscape.png', function(texture) {
                        const material = new THREE.MeshBasicMaterial({ map: texture });
                        const sphere = new THREE.Mesh(geometry, material);
                        scene.add(sphere);
                    });
                    
                    // éŸ³æ¥½è¨­å®š
                    audio = document.getElementById('bgAudio');
                    
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
                    animate();
                }
                
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                
                function toggleAudio() {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                    }
                }
                
                function enterVR() {
                    if (navigator.xr) {
                        // WebXR VRå®Ÿè£…
                        alert('VRæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
                    } else {
                        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯VRã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                    }
                }
                
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
                window.addEventListener('resize', function() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                init();
            </script>
        </body>
        </html>'''
        
        with open('dist/index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
            
        print("ãƒ‘ãƒãƒ©ãƒVRãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ç”Ÿæˆå®Œäº†")
        
        # assetsãƒ•ã‚©ãƒ«ãƒ€ã‚’distã«ã‚³ãƒ”ãƒ¼
        import shutil
        if os.path.exists('assets'):
            if os.path.exists('dist/assets'):
                shutil.rmtree('dist/assets')
            shutil.copytree('assets', 'dist/assets')
            print("assetsãƒ•ã‚©ãƒ«ãƒ€ã‚’distã«ã‚³ãƒ”ãƒ¼å®Œäº†")
        EOF
        
    - name: Phase 3 - Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist