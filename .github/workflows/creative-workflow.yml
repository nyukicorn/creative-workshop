name: Creative Workshop v2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  creative-workflow:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python and Dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Claude Code SDK
      run: |
        pip install anthropic requests pillow
        
    - name: Setup MCP Configuration
      run: |
        mkdir -p ~/.claude
        echo '${{ secrets.MCP_CONFIG }}' > ~/.claude/mcp-kamuicode.json
        
    - name: Phase 1 - Panorama Asset Generation (Kamui Code MCP)
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Kamui Code MCPã§ãƒ‘ãƒãƒ©ãƒç´ æç”Ÿæˆé–‹å§‹"
        mkdir -p assets/panorama assets/audio
        python3 << 'EOF'
        import os
        import sys
        import requests
        import json
        import time
        from anthropic import Anthropic
        
        # Claude Code SDK ã§MCPçµŒç”±ã§ç´ æç”Ÿæˆ
        client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
        
        def generate_panorama_with_mcp(theme="æ£®ã®é¢¨æ™¯"):
            print(f"ğŸ–¼ï¸ ãƒ†ãƒ¼ãƒã€Œ{theme}ã€ã§ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆä¸­...")
            
            # Claude Code SDKçµŒç”±ã§Kamui Code MCPã‚’å‘¼ã³å‡ºã—
            message = client.messages.create(
                model="claude-3-5-sonnet-20241022",
                max_tokens=4000,
                messages=[{
                    "role": "user",
                    "content": f"""
                    Kamui Code MCPã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ä»•æ§˜ã§360åº¦ãƒ‘ãƒãƒ©ãƒç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
                    
                    ãƒ†ãƒ¼ãƒ: {theme}
                    
                    ä»•æ§˜:
                    - 360åº¦ãƒ‘ãƒãƒ©ãƒï¼ˆEquirectangularå½¢å¼ï¼‰
                    - é«˜è§£åƒåº¦ï¼ˆæœ€ä½2048x1024ï¼‰
                    - VRä½“é¨“ã«é©ã—ãŸæ²¡å…¥æ„Ÿã®ã‚ã‚‹ç’°å¢ƒ
                    - ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®assets/panoramaãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
                    - ãƒ•ã‚¡ã‚¤ãƒ«å: panorama_landscape.png
                    
                    ç”Ÿæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    """
                }]
            )
            
            print("ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆå¿œç­”:", message.content[0].text[:200] + "...")
            
        def generate_audio_with_mcp(theme="æ£®ã®è‡ªç„¶éŸ³"):
            print(f"ğŸµ ãƒ†ãƒ¼ãƒã€Œ{theme}ã€ã§ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆä¸­...")
            
            message = client.messages.create(
                model="claude-3-5-sonnet-20241022",
                max_tokens=4000,
                messages=[{
                    "role": "user", 
                    "content": f"""
                    Kamui Code MCPã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ä»•æ§˜ã§ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
                    
                    ãƒ†ãƒ¼ãƒ: {theme}
                    
                    ä»•æ§˜:
                    - 60ç§’é–“ã®ãƒ«ãƒ¼ãƒ—å¯èƒ½ãªéŸ³æ¥½
                    - VRä½“é¨“ã«é©ã—ãŸãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã‚‹ã‚µã‚¦ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—
                    - ç’°å¢ƒã«é©ã—ãŸè‡ªç„¶éŸ³ã‚„ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³
                    - ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®assets/audioãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
                    - ãƒ•ã‚¡ã‚¤ãƒ«å: ambient_background.wav
                    
                    ç”Ÿæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    """
                }]
            )
            
            print("ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆå¿œç­”:", message.content[0].text[:200] + "...")
        
        # å®Ÿéš›ã®ç”Ÿæˆå®Ÿè¡Œ
        try:
            generate_panorama_with_mcp("ç¥ç§˜çš„ãªæ£®ã®é¢¨æ™¯")
            time.sleep(5)  # ç”Ÿæˆå¾…æ©Ÿ
            generate_audio_with_mcp("æ£®ã®è‡ªç„¶éŸ³ã¨ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆ")
            time.sleep(5)  # ç”Ÿæˆå¾…æ©Ÿ
            
            print("âœ… MCPçµŒç”±ã§ã®ç´ æç”Ÿæˆå®Œäº†")
            
        except Exception as e:
            print(f"âŒ MCPç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            print("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨")
            
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            import shutil
            if os.path.exists('creative-workshop-v2/assets/imagen_imagen-3.0-generate-002_20250709_224034_0.png'):
                shutil.copy('creative-workshop-v2/assets/imagen_imagen-3.0-generate-002_20250709_224034_0.png', 'assets/panorama/panorama_landscape.png')
                print("ãƒ‘ãƒãƒ©ãƒç”»åƒ: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†")
            if os.path.exists('creative-workshop-v2/assets/audio/lyria_output_Rz0Lm9sHg.wav'):
                shutil.copy('creative-workshop-v2/assets/audio/lyria_output_Rz0Lm9sHg.wav', 'assets/audio/ambient_background.wav')
                print("ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†")
        
        # ç”Ÿæˆçµæœç¢ºèª
        panorama_exists = os.path.exists('assets/panorama/panorama_landscape.png')
        audio_exists = os.path.exists('assets/audio/ambient_background.wav')
        
        print(f"ğŸ“Š ç”Ÿæˆçµæœ: ãƒ‘ãƒãƒ©ãƒç”»åƒ={panorama_exists}, éŸ³æ¥½={audio_exists}")
        EOF
        
    - name: Verify Panorama Asset Generation
      run: |
        echo "ãƒ‘ãƒãƒ©ãƒç´ æç”Ÿæˆç¢ºèª"
        ls -la assets/panorama/ || echo "No panorama directory"
        ls -la assets/audio/ || echo "No audio directory"
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª"
        du -h assets/panorama/* || echo "No panorama files"
        du -h assets/audio/* || echo "No audio files"
        
    - name: Upload Generated Assets
      uses: actions/upload-artifact@v4
      with:
        name: generated-assets
        path: assets/
        retention-days: 30
        
    - name: Phase 2 - Panorama VR Integration (Three.js)
      run: |
        echo "Three.jsã§ãƒ‘ãƒãƒ©ãƒVRçµ±åˆé–‹å§‹"
        mkdir -p dist
        python3 << 'EOF'
        import os
        import json
        
        # Three.js ãƒ‘ãƒãƒ©ãƒãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ç”Ÿæˆ
        html_content = '''<!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>360Â° Panorama VR Experience</title>
            <style>
                body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
                #info { position: absolute; top: 10px; left: 10px; color: white; z-index: 100; }
                #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
                button { padding: 10px 20px; margin: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px; cursor: pointer; }
                button:hover { background: rgba(0,0,0,0.9); }
            </style>
        </head>
        <body>
            <div id="info">
                <h3>360Â° Panorama VR</h3>
                <p>ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ç§»å‹• | ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  | VRå¯¾å¿œ</p>
            </div>
            <div id="controls">
                <button onclick="toggleAudio()">éŸ³æ¥½ ON/OFF</button>
                <button onclick="enterVR()">VRãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            <audio id="bgAudio" loop>
                <source src="./assets/audio/ambient_background.wav" type="audio/wav">
            </audio>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
            <script>
                let scene, camera, renderer, controls, audio;
                
                function init() {
                    // ã‚·ãƒ¼ãƒ³è¨­å®š
                    scene = new THREE.Scene();
                    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    document.body.appendChild(renderer.domElement);
                    
                    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    controls.enableZoom = true;
                    controls.enablePan = false;
                    controls.enableRotate = true;
                    controls.rotateSpeed = 0.5;
                    controls.zoomSpeed = 1.5;
                    controls.minDistance = 1;
                    controls.maxDistance = 200;
                    
                    // ãƒ‘ãƒãƒ©ãƒã‚¹ãƒ•ã‚£ã‚¢ä½œæˆ
                    const geometry = new THREE.SphereGeometry(500, 60, 40);
                    geometry.scale(-1, 1, 1); // å†…å´ã‹ã‚‰è¦‹ãˆã‚‹ã‚ˆã†ã«åè»¢
                    
                    const loader = new THREE.TextureLoader();
                    loader.load('./assets/panorama/panorama_landscape.png', function(texture) {
                        const material = new THREE.MeshBasicMaterial({ map: texture });
                        const sphere = new THREE.Mesh(geometry, material);
                        scene.add(sphere);
                    });
                    
                    // éŸ³æ¥½è¨­å®š
                    audio = document.getElementById('bgAudio');
                    
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
                    animate();
                }
                
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                
                function toggleAudio() {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                    }
                }
                
                function enterVR() {
                    if (navigator.xr) {
                        // WebXR VRå®Ÿè£…
                        alert('VRæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
                    } else {
                        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯VRã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                    }
                }
                
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
                window.addEventListener('resize', function() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                init();
            </script>
        </body>
        </html>'''
        
        with open('dist/index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
            
        print("ãƒ‘ãƒãƒ©ãƒVRãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ç”Ÿæˆå®Œäº†")
        
        # assetsãƒ•ã‚©ãƒ«ãƒ€ã‚’distã«ã‚³ãƒ”ãƒ¼
        import shutil
        if os.path.exists('assets'):
            if os.path.exists('dist/assets'):
                shutil.rmtree('dist/assets')
            shutil.copytree('assets', 'dist/assets')
            print("assetsãƒ•ã‚©ãƒ«ãƒ€ã‚’distã«ã‚³ãƒ”ãƒ¼å®Œäº†")
        EOF
        
    - name: Phase 3 - Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist