# Three.js パーティクルシステム 成功ガイド

## 🎯 成功したパーティクル設定

### 重要な成功要因

#### 1. **マテリアル設定（最重要）**
```javascript
const particleMaterial = new THREE.PointsMaterial({
    size: 0.1,
    vertexColors: true,
    transparent: false, // 👈 これが重要！true にすると見えなくなる
    // blending: THREE.AdditiveBlending // 👈 これも削除！
});
```

#### 2. **実行タイミング**
- ❌ **失敗**: 3秒後の自動実行
- ✅ **成功**: 5秒後の手動実行
- **理由**: 画像読み込みとWebSocket接続が完了してから実行する必要がある

#### 3. **位置計算**
```javascript
// 背景画像の位置と正確に合わせる
const px = ((x / canvas.width) - 0.5) * 8.0;  // 背景幅8に合わせる
const py = 2 + ((0.5 - y / canvas.height) * 4.5);  // 背景高さ4.5、中心Y=2に合わせる
const pz = -2 + (Math.random() - 0.5) * 0.2;  // 背景のZ=-2より少し手前
```

#### 4. **パーティクル密度**
```javascript
const maxSize = 150;  // 処理画像サイズ
for (let y = 0; y < canvas.height; y += 1) {  // 間引きなし
    for (let x = 0; x < canvas.width; x += 1) {
        // 全ピクセルを処理
    }
}
```

## ❌ 失敗の原因と対策

### 1. **見えないパーティクルの原因**
| 問題 | 原因 | 解決策 |
|------|------|--------|
| パーティクルが全く表示されない | `transparent: true` + `AdditiveBlending` | `transparent: false` に変更 |
| パーティクルが黒く見える | `AdditiveBlending` が暗い色を強調 | `blending` プロパティを削除 |
| パーティクルが小さすぎる | `size` が0.01など極小値 | `size: 0.1` 以上に設定 |

### 2. **位置ずれの原因**
| 問題 | 原因 | 解決策 |
|------|------|--------|
| パーティクルが上半分に表示されない | Y座標計算のオフセットミス | 背景画像の中心座標に合わせる |
| パーティクルが画像からはみ出る | 座標スケールが背景画像と不一致 | 背景画像のサイズ（8x4.5）と一致させる |

### 3. **タイミング問題**
| 問題 | 原因 | 解決策 |
|------|------|--------|
| パーティクルが生成されない | 画像読み込み完了前に実行 | 画像のonloadイベント内で実行 |
| WebSocket通信エラー | 接続完了前にコマンド送信 | 適切な待機時間を設ける |

## 🚀 今後の改善ステップ

### Phase 1: 基本機能向上
- [ ] パーティクルサイズの動的調整
- [ ] 色の彩度・明度調整
- [ ] アルファ閾値の最適化

### Phase 2: 視覚効果追加
- [ ] パーティクルアニメーション（浮遊効果）
- [ ] マウス操作による相互作用
- [ ] ライティング効果

### Phase 3: パフォーマンス最適化
- [ ] LOD（Level of Detail）システム
- [ ] GPU インスタンシング
- [ ] メモリ使用量最適化

## 📝 チェックリスト

### 新しいパーティクルシステム作成時
- [ ] `transparent: false` に設定
- [ ] `blending` プロパティは削除
- [ ] 背景画像の座標系と位置計算を一致させる
- [ ] 画像読み込み完了後に実行
- [ ] 適切なパーティクルサイズ（0.05-0.2）
- [ ] アルファ閾値テスト（0.1-0.5）

### デバッグ時
- [ ] コンソールでパーティクル数確認
- [ ] シーン内オブジェクト一覧確認
- [ ] パーティクルの位置・可視状態確認
- [ ] テスト用シンプルパーティクルで動作確認

## 💡 重要な学び

1. **Three.jsのデフォルト動作を理解する**: `transparent: true` は必ずしも良い選択ではない
2. **段階的デバッグの重要性**: 複雑なシステムは要素を分解してテストする
3. **座標系の一貫性**: 背景オブジェクトとパーティクルの座標系を合わせる
4. **非同期処理の管理**: 画像読み込みなどの完了を待つ

## 🔧 トラブルシューティング

### パーティクルが見えない場合
1. テスト用パーティクル（1個、大きなサイズ）で基本動作確認
2. マテリアル設定を `transparent: false` に変更
3. パーティクル位置をカメラの目の前に移動
4. コンソールでパーティクル数・位置確認

### 位置がずれる場合
1. 背景画像のサイズと座標系確認
2. パーティクル座標計算式の見直し
3. 背景画像の中心位置とパーティクル原点の一致確認