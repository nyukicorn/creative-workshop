name: Creative Workshop v2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  creative-workflow:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Python and Dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        pip install requests pillow
        
    - name: Install Claude Code CLI
      run: |
        npm config get registry
        npm cache clean --force
        npm install -g @anthropic-ai/claude-code
        which claude || { echo "âŒ claude ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; exit 1; }
        
    - name: Setup MCP Config
      run: |
        mkdir -p ~/.claude
        cp configs/mcp-kamuicode.json ~/.claude/mcp-config.json
        echo "MCPè¨­å®šå†…å®¹ç¢ºèª:"
        cat ~/.claude/mcp-config.json
        echo "Kamui Code MCP URLã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª"
        grep -q "mcp-veo3-fast-only" ~/.claude/mcp-config.json && echo "âœ… Kamui Code MCPç¢ºèªæ¸ˆã¿" || echo "âŒ è¨­å®šã‚¨ãƒ©ãƒ¼"
        
    - name: Phase 1 - Generate Assets with Claude Code + Kamui MCP
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Claude Code + Kamui Code MCPã§æ–°ã—ã„ç´ æã‚’ç”Ÿæˆé–‹å§‹"
        mkdir -p assets/panorama assets/audio
        
        echo "ğŸ–¼ï¸ Imagen3ã§ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆä¸­..."
        claude --mcp-config=~/.claude/mcp-config.json "Kamui Code MCPã®Imagen3ã‚’ä½¿ç”¨ã—ã¦ã€ã€Œç¥ç§˜çš„ãªæ£®ã®ä¸­ã®å¤ã„çŸ³ã®éºè·¡ã€å¤•æš®ã‚Œã®å…‰ãŒå·®ã—è¾¼ã‚€å¹»æƒ³çš„ãª360åº¦ãƒ‘ãƒãƒ©ãƒé¢¨æ™¯ã€Equirectangularå½¢å¼ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã§1024x1024ã‚µã‚¤ã‚ºã®ç”»åƒã‚’ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®assets/panorama/panorama_landscape.pngã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚çµ¶å¯¾ã«Google APIã‚’ç›´æ¥å‘¼ã³å‡ºã•ãšã€å¿…ãšKamui Code MCPã‚’çµŒç”±ã—ã¦ãã ã•ã„ã€‚"
        
        echo "ğŸµ Lyriaã§ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆä¸­..."
        claude --mcp-config=~/.claude/mcp-config.json "Kamui Code MCPã®Lyriaã‚’ä½¿ç”¨ã—ã¦ã€ã€Œæ£®ã®è‡ªç„¶éŸ³ã¨ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆã€VRä½“é¨“ã«é©ã—ãŸãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã‚‹ã‚µã‚¦ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ã€60ç§’ãƒ«ãƒ¼ãƒ—å¯èƒ½ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã§éŸ³æ¥½ã‚’ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®assets/audio/ambient_background.wavã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚çµ¶å¯¾ã«Google APIã‚’ç›´æ¥å‘¼ã³å‡ºã•ãšã€å¿…ãšKamui Code MCPã‚’çµŒç”±ã—ã¦ãã ã•ã„ã€‚"
        
        # ç”Ÿæˆçµæœç¢ºèª
        echo "ğŸ“Š ç”Ÿæˆçµæœç¢ºèª"
        ls -la assets/panorama/ || echo "ãƒ‘ãƒãƒ©ãƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
        ls -la assets/audio/ || echo "ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
        
        if [ -f "assets/panorama/panorama_landscape.png" ]; then
            echo "âœ… ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆå®Œäº†: $(du -h assets/panorama/panorama_landscape.png | cut -f1)"
        else
            echo "âŒ ãƒ‘ãƒãƒ©ãƒç”»åƒç”Ÿæˆå¤±æ•—"
        fi
        
        if [ -f "assets/audio/ambient_background.wav" ]; then
            echo "âœ… ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆå®Œäº†: $(du -h assets/audio/ambient_background.wav | cut -f1)"
        else
            echo "âŒ ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³æ¥½ç”Ÿæˆå¤±æ•—"
        fi
        
    - name: Verify Panorama Asset Generation
      run: |
        echo "ãƒ‘ãƒãƒ©ãƒç´ æç”Ÿæˆç¢ºèª"
        ls -la assets/panorama/ || echo "No panorama directory"
        ls -la assets/audio/ || echo "No audio directory"
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª"
        du -h assets/panorama/* || echo "No panorama files"
        du -h assets/audio/* || echo "No audio files"
        
    - name: Upload Generated Assets
      uses: actions/upload-artifact@v4
      with:
        name: generated-assets
        path: assets/
        retention-days: 30
        
    - name: Phase 2 - Panorama VR Integration (Three.js)
      run: |
        echo "Three.jsã§ãƒ‘ãƒãƒ©ãƒVRçµ±åˆé–‹å§‹"
        mkdir -p dist
        python3 << 'EOF'
        import os
        import json
        
        # Three.js ãƒ‘ãƒãƒ©ãƒãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ç”Ÿæˆ
        html_content = '''<!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>360Â° Panorama VR Experience</title>
            <style>
                body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
                #info { position: absolute; top: 10px; left: 10px; color: white; z-index: 100; }
                #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
                button { padding: 10px 20px; margin: 5px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 5px; cursor: pointer; }
                button:hover { background: rgba(0,0,0,0.9); }
            </style>
        </head>
        <body>
            <div id="info">
                <h3>360Â° Panorama VR</h3>
                <p>ãƒ‰ãƒ©ãƒƒã‚°ã§è¦–ç‚¹ç§»å‹• | ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  | VRå¯¾å¿œ</p>
            </div>
            <div id="controls">
                <button onclick="toggleAudio()">éŸ³æ¥½ ON/OFF</button>
                <button onclick="enterVR()">VRãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            <audio id="bgAudio" loop>
                <source src="./assets/audio/ambient_background.wav" type="audio/wav">
            </audio>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
            <script>
                let scene, camera, renderer, controls, audio;
                
                function init() {
                    // ã‚·ãƒ¼ãƒ³è¨­å®š
                    scene = new THREE.Scene();
                    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    document.body.appendChild(renderer.domElement);
                    
                    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    controls.enableZoom = true;
                    controls.enablePan = false;
                    controls.enableRotate = true;
                    controls.rotateSpeed = 0.5;
                    controls.zoomSpeed = 1.5;
                    controls.minDistance = 1;
                    controls.maxDistance = 200;
                    
                    // ãƒ‘ãƒãƒ©ãƒã‚¹ãƒ•ã‚£ã‚¢ä½œæˆ
                    const geometry = new THREE.SphereGeometry(500, 60, 40);
                    geometry.scale(-1, 1, 1); // å†…å´ã‹ã‚‰è¦‹ãˆã‚‹ã‚ˆã†ã«åè»¢
                    
                    const loader = new THREE.TextureLoader();
                    loader.load('./assets/panorama/panorama_landscape.png', function(texture) {
                        const material = new THREE.MeshBasicMaterial({ map: texture });
                        const sphere = new THREE.Mesh(geometry, material);
                        scene.add(sphere);
                    });
                    
                    // éŸ³æ¥½è¨­å®š
                    audio = document.getElementById('bgAudio');
                    
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
                    animate();
                }
                
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                
                function toggleAudio() {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                    }
                }
                
                function enterVR() {
                    if (navigator.xr) {
                        // WebXR VRå®Ÿè£…
                        alert('VRæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
                    } else {
                        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯VRã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
                    }
                }
                
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
                window.addEventListener('resize', function() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                init();
            </script>
        </body>
        </html>'''
        
        with open('dist/index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
            
        print("ãƒ‘ãƒãƒ©ãƒVRãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ç”Ÿæˆå®Œäº†")
        
        # assetsãƒ•ã‚©ãƒ«ãƒ€ã‚’distã«ã‚³ãƒ”ãƒ¼
        import shutil
        if os.path.exists('assets'):
            if os.path.exists('dist/assets'):
                shutil.rmtree('dist/assets')
            shutil.copytree('assets', 'dist/assets')
            print("assetsãƒ•ã‚©ãƒ«ãƒ€ã‚’distã«ã‚³ãƒ”ãƒ¼å®Œäº†")
        EOF
        
    - name: Phase 3 - Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist